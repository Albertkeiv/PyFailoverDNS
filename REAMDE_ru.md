# PyFailoverDNS
PyFailoverDNS — это система отказоустойчивого DNS, которая динамически возвращает IP-адреса на основе реальной доступности целевых хостов. Основная цель — обеспечить бесперебойный доступ к сервисам с возможностью автоматического переключения на fallback-адреса в случае сбоев.

## Зачем это нужно
Обычные DNS-записи не учитывают текущее состояние серверов. Если основной IP-адрес недоступен, клиент продолжает пытаться подключиться к нему. PyFailoverDNS решает эту проблему, автоматически выбирая живой IP на основе проверок, проводимых агентами мониторинга. Это позволяет:

+ Повысить отказоустойчивость сервисов

+ Автоматически исключать неработающие узлы из DNS-ответов

+ Использовать fallback-IP в случае полного отказа

## Возможности

+ Поддержка нескольких доменных зон

+ Гибкая конфигурация проверок и fallback-адресов

+ Политика принятия решений (any, в будущем — quorum, priority, all)

+ REST API для получения статуса доменов и назначения заданий агентам

+ Локальный DNS-сервер, обрабатывающий .failover зоны

+ Поддержка тегов агентов для распределения заданий

+ Кэширование DNS-ответов на заданное время


## Как работает
1. Агенты мониторинга выполняют регулярные TCP/HTTP/ICMP-проверки заданных хостов.

2. Они отправляют отчёты на мастер-сервер через REST API (/api/v1/report).

3. Мастер собирает и обрабатывает отчёты от агентов, применяя заданную политику (например, any, quorum, all).

4. DNS-сервер, встроенный в мастер, отвечает на запросы, выбирая IP на основе актуального состояния.

5. Если все проверки неуспешны — возвращается fallback-адрес.


## Пример конфигурации config.yaml (мастер-сервер)
```
dns:
  listen_ip: "0.0.0.0"
  listen_port: 8053
  resolve_cache_ttl: 5

api:
  listen_ip: "0.0.0.0"
  listen_port: 8000

zones:
  - name: "failover"
    fallback_ttl: 30
    domains:
      webmail.failover:
        fallback:
          - "10.10.10.254"
        server:
          policy: any
          timeout_sec: 60
        monitor:
          mode: tcp
          monitor_tag: test
          targets:
            - ip: 10.10.10.250
              port: 80
        agent:
          interval_sec: 30
          timeout_sec: 5
```

## Пример конфигурации агента agent_config.yaml
```
agent_id: example

servers:
  - name: server1
    url: http://server_ip_or_dns:8000
    tags:
      - test
```


## Запуск
### Мастер-сервер:
`python main.py --config <path_to_config.yaml>`

### Агент:
`python agent.py --config <path_to_config.yaml>`

## Зависимости
+ fastapi

+ uvicorn

+ dnslib

+ pyyaml

+ pydantic

+ dnspython

## Интеграция с CoreDNS
Если вы уже используете CoreDNS как часть вашей инфраструктуры (например, в Kubernetes), вы можете легко подключить PyFailoverDNS как внешний источник для определённой зоны (например, .failover).

### Пример конфигурации CoreDNS (Corefile)
```
. {
  forward . 1.1.1.1 8.8.8.8
  log
  errors
}

failover {
  forward . 127.0.0.1:8053
}
```

### Объяснение:
+ Все обычные домены будут обрабатываться через forward . 1.1.1.1 8.8.8.8.

+ Зона failover (например, webmail.failover) будет перенаправляться на локальный PyFailoverDNS, запущенный на порту 8053.

### Что нужно сделать:
1. Убедитесь, что PyFailoverDNS слушает на 0.0.0.0:8053 (или на localhost:8053).

2. Убедитесь, что в config.yaml задана зона failover с нужными доменами.

3. Перезапустите CoreDNS с обновлённым Corefile.

### Пример запроса
```
dig @127.0.0.1 -p 8053 webmail.failover
```

CoreDNS передаст запрос PyFailoverDNS, который вернёт IP на основе состояния агентов.